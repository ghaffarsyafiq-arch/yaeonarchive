<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Unit Usaha</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #eee;
            color: #333;
            text-align: center;
            padding: 20px;
            transition: background 0.5s;
        }
        .container { border: 2px solid #333; padding: 20px; background: white; }
        h2 { text-transform: uppercase; margin: 0; }
        .stat { font-size: 2em; font-weight: bold; margin: 10px 0; color: green; }
        .danger-mode {
            background: #ff0000;
            color: white;
            animation: shake 0.5s infinite;
        }
        .danger-mode .container { background: #ffcccc; color: red; border-color: red; }
        .danger-mode .stat { color: red; }
        
        button { padding: 10px 20px; cursor: pointer; font-size: 1.2em; font-weight: bold;}
        
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 100% { transform: translate(1px, -1px) rotate(0deg); } }
    </style>
</head>
<body>

    <div class="container">
        <h2 id="bizType">Loading...</h2>
        <div class="stat" id="indicator">+$0</div>
        <p id="statusMsg">Beroperasi Normal</p>
        <button onclick="fixProblem()" id="fixBtn" style="display:none">PERBAIKI ($50)</button>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const type = params.get('type') || 'cafe';
        const channel = new BroadcastChannel('rich21_luna');

        // Config Bisnis
        const config = {
            cafe: { name: "Kafe Kopi", profit: 15, risk: 0.05 },
            crypto: { name: "Mining Rig", profit: 80, risk: 0.2 }
        };

        const biz = config[type];
        document.getElementById('bizType').innerText = biz.name;
        
        let isCritical = false;

        // Loop Usaha
        setInterval(() => {
            if (isCritical) {
                // Kalau rusak, malah rugi
                let loss = -biz.profit * 2;
                channel.postMessage({ type: 'INCOME', amount: loss });
                document.getElementById('indicator').innerText = loss;
            } else {
                // Normal
                channel.postMessage({ type: 'INCOME', amount: biz.profit });
                document.getElementById('indicator').innerText = "+$" + biz.profit;
                
                // Cek kemungkinan bencana acak
                if (Math.random() < biz.risk) triggerDisaster();
            }
        }, 1500);

        function triggerDisaster() {
            isCritical = true;
            document.body.classList.add('danger-mode');
            document.getElementById('statusMsg').innerText = "RUSAK! / KENA HACK!";
            document.getElementById('fixBtn').style.display = 'inline-block';
            
            // Lapor ke LUNA
            channel.postMessage({ 
                type: 'CRITICAL_EVENT', 
                msg: `GAWAT! ${biz.name} bermasalah! Cek Tab-nya sekarang!` 
            });
        }

        function fixProblem() {
            isCritical = false;
            document.body.classList.remove('danger-mode');
            document.getElementById('statusMsg').innerText = "Beroperasi Normal";
            document.getElementById('fixBtn').style.display = 'none';
            channel.postMessage({ type: 'INCOME', amount: -50 }); // Biaya perbaikan
        }

        // Deteksi Tutup Tab
        window.onbeforeunload = () => {
            channel.postMessage({ type: 'TAB_CLOSED' });
        };
        
        // Terima info ganti hari
        channel.onmessage = (e) => {
            if(e.data.type === 'NEXT_DAY') {
                // Reset status tiap hari
                isCritical = false;
                document.body.classList.remove('danger-mode');
                document.getElementById('fixBtn').style.display = 'none';
            }
        }
    </script>
</body>
</html>
